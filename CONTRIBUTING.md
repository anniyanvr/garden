# Developing the Garden CLI framework

## Contributing guidelines

We heartily welcome any form of contribution to the project, including issue reports, feature requests,
discussion, pull requests and any type of feedback. We request that all contributors
adhere to the [Contributor Covenant](CODE_OF_CONDUCT.md) and work with us to make the collaboration and
community productive and fun for everyone :)

## Commit messages

We follow and automatically validate
[Angular-like formatting](https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#commits) for our
commit messages, for consistency and clarity. In particular, the **type** of the commit header must be one of the following:

* **feat**: A new feature
* **fix**: A bug fix
* **docs**: Documentation only changes
* **style**: Changes that do not affect the meaning of the code (white-space, formatting, missing
  semi-colons, etc)
* **refactor**: A code change that neither fixes a bug nor adds a feature
* **perf**: A code change that improves performance
* **test**: Adding missing or correcting existing tests
* **chore**: Changes to the build process or auxiliary tools and libraries such as documentation
  generation

When generating the changelog, we only include the following types: **feat**, **fix**, **refactor**, and **perf**. This means that any changes that the user should be aware of, should have one of these types.

## Setting up your development environment

### Step 1: Install Docker and Kubernetes

Please refer to our [installation docs](./docs/basics/installation.md) for instructions on how to install Docker and Kubernetes for different platforms.

### Step 2: Clone the repo

    git clone https://github.com/garden-io/garden.git

### Step 3: Install dependencies

#### OSX

For Mac we have a script that installs all required dependencies.

If you haven't already, please [install Homebrew](https://docs.brew.sh/Installation). Then run:

    ./bin/bootstrap-osx

#### Windows / Linux

Other platforms need to roll their own for now (contributions welcome!). Please have a look at the script for OSX to see what's installed.

**Note:** We recommend using Node 10 when developing Garden.

### Step 4: Bootstrap project

Install Node modules for the root package, and the `dashboard` and `garden-service` packages:

    npm run bootstrap

Install Go dependencies for the `garden-cli`:

    dep ensure

## Running a development version of the CLI

While developing the CLI, we recommend you run the dev command in your console:

    cd garden-service
    npm run dev

This will do an initial development build, `npm link` it to your global npm folder, and then watch for
changes and auto-rebuild as you code. You can then run the `garden` command as normal.

Also, you might like to add a couple of shorthands:

    alias g='garden'
    alias k='kubectl'

## Testing

Tests are run using `mocha`. To run the full test suite, including linting and other validation, simply run
from the root:

    npm test

### CI

We use [Circle CI](https://circleci.com) for integration testing. Sometimes
it can be useful to test and debug the CI build locally, particularly when
updating or adding dependencies. You can use their
[CLI](https://circleci.com/docs/2.0/local-jobs/) for that, which
is installed automatically by the `./bin/bootstrap-osx` script. Once you
have it installed you can run `circleci build` in the repo root to test
the build locally.

## License/copyright headers

Every source file must include the contents of `static/license-header.txt` at the top. This is
automatically checked during CI. You can run the check with `npm run check-licenses`.

## Release process

Our release process is currently manual and requires releasing different packages for different platforms. We're working on unifying and automating the process.

Currently we maintain the following:

* An executable for Windows and Linux, generated by [Pkg](https://github.com/zeit/pkg) and hosted on our [Github page](https://github.com/garden-io/garden/releases).
* A [Homebrew](https://brew.sh/) package for macOS users.
* An [NPM](https://www.npmjs.com/package/garden-cli) package that the Homebrew package depends on.

To make a new release, set your current working directory to garden root and follow the steps below. The examples assume we're creating a release for `v0.8.0-rc2`:

1. Checkout out to a new release branch, e.g. `git checkout -b release-0.8.0-rc2`.
2. Update the `version` field in `./garden-service/package.json` to the new release name.
3. Run `cd garden-service && npm install && cd ..` to update `package-lock.json`.
4. Create a new tag for the version: `git tag -a v0.8.0-rc2 -m 'chore(release): release v0.8.0-rc2'`
5. Get the changelog for the tag with: `git-chglog v0.8.0-rc2` and prepend the output to `CHANGELOG.md`. Alternatively you can generate the entire `CHANGELOG.md` file with `git-chglog -o=CHANGELOG.md v0.1.0..v0.8.0-rc2`, but make sure that older entries do not change (this can happen if you have local tags that do not match the remote release tags).
6. Add the `CHANGELOG.md`, `garden/servicepackage.json` and `garden-service/package-lock.json` files, and commit:
   `git add CHANGELOG.md garden-service/package.json garden-service/package-lock.json && git commit -m 'chore(release): bump version to 0.8.0-rc2'`
7. Update the tag (this is so we can include the changelog in the same tag):
   `git tag -f -a v0.8.0-rc2 -m 'chore(release): release v0.8.0-rc2'`
8. Push the new tag: `git push origin v0.8.0-rc2 --no-verify`. This will trigger the dist build process in CircleCI.
9. Open the [Garden project on CircleCI](https://circleci.com/gh/garden-io/garden),
   browse to the job marked `release-service-pkg`, open the _Artifacts_ tab and download the listed artifacts.
10. Go to our Github [Releases tab](https://github.com/garden-io/garden/releases) and click the **Draft a new release** button.
11. Fill in the **Tag version** and **Release title** fields with the new release version (same as you used for the tag).
12. Upload the downloaded artifacts.
13. Write release notes (not necessary for RCs). The notes should _at least_ contain the changelog.
14. Click the **Publish release** button.
15. Push the branch and make a pull request.
16. If you're making an RC, you're done! Otherwise, you need to update Homebrew package: `gulp update-brew`
